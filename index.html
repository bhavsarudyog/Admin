<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Panel - Bhavsar Udyog (Cards Dashboard)</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/feather-icons"></script>

<style>
  :root{
    --bg: #f6f8fb;
    --panel: #ffffff;
    --muted: #6b7280;
    --accent: #6366f1;
    --glass: rgba(255,255,255,0.6);
    --shadow: 0 8px 30px rgba(15,23,42,0.06);
  }
  .dark {
    --bg: #071226;
    --panel: rgba(8,20,30,0.6);
    --muted: #9fb6cc;
    --accent: #7c3aed;
    --glass: rgba(9,26,38,0.6);
    --shadow: 0 14px 40px rgba(1,6,19,0.6);
  }

  html,body { height:100%; background:var(--bg); color:var(--muted); font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .glass { background: linear-gradient(90deg, rgba(255,255,255,0.4), rgba(255,255,255,0.06)); backdrop-filter: blur(6px); }
  .panel { background: var(--panel); box-shadow: var(--shadow); border-radius: 12px; }
  .accent { color: var(--accent); }
  .btn { transition: transform .12s ease, box-shadow .12s ease; }
  .btn:hover { transform: translateY(-3px); }
  .card-img { width:100%; height:100%; object-fit:cover; border-radius:8px; cursor:pointer; display:block; }
  .pending-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #ef4444;
    color: #fff;
    padding: 2px 10px;
    border-radius: 9999px;
    font-size: 0.85rem;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(239,68,68,0.15);
    animation: pulse 1.2s infinite;
    z-index: 2;
    display: inline-block;
    vertical-align: middle;
    margin-left: 8px;
  }
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
    70% { box-shadow: 0 0 0 8px rgba(239,68,68,0); }
    100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
  }
  .detail-row { padding:10px; background: rgba(0,0,0,0.03); border-radius:8px; margin-bottom:8px; }
  .fade-in { animation: fadeIn .22s ease both; opacity:0; }
  @keyframes fadeIn { to{ opacity:1; } }
  .small-muted { color: var(--muted); font-size:0.92rem; }
  .topbar { backdrop-filter: blur(8px); }
  @media (max-width: 900px) {
    .topbar .nav-tabs { display:none; }
    .topbar .small-nav { display:flex; gap:8px; }
  }
</style>
</head>
<body class="antialiased">

<!-- NAVBAR -->
<header class="topbar fixed left-0 right-0 z-50 panel glass px-4 py-3 flex items-center justify-between gap-4">
  <div class="flex items-center gap-4">
    <div class="flex items-center gap-3">
      <img src="BhavsarUdyog.png" alt="Bhavsar Udyog Logo" class="h-10 w-10 rounded-full object-cover bg-white shadow" />
      <div>
        <div class="font-semibold text-lg">Bhavsar Udyog — Admin</div>
        <div class="small-muted">Top navbar · Cards dashboard</div>
      </div>
    </div>

    <!-- tabs (desktop) -->
    <nav class="nav-tabs ml-8 flex items-center gap-2">
      <button id="tab-users-btn" class="px-3 py-2 rounded-md btn bg-indigo-50 text-indigo-700">Users</button>
      <button id="tab-mybus-btn" class="px-3 py-2 rounded-md btn hover:bg-indigo-50">My Business</button>
      <button id="tab-final-btn" class="px-3 py-2 rounded-md btn hover:bg-indigo-50">Approved</button>
    </nav>

    <!-- small nav (mobile) -->
    <div class="small-nav hidden"></div>
  </div>

  <div class="flex items-center gap-3">
    <div id="user-email-display" class="small-muted mr-2"></div>
    <button id="theme-toggle" title="Toggle theme" class="px-3 py-2 rounded-md panel btn small-muted"><i data-feather="sun"></i></button>
    <button id="signout-btn" class="px-3 py-2 rounded-md bg-red-500 text-white btn">Sign out</button>
  </div>
</header>

<!-- MAIN -->
<main class="pt-24 px-4 pb-12 max-w-1200 mx-auto">

  <!-- LOGIN modal / card shown when not signed in -->
  <div id="login-area" class="max-w-xl mx-auto mt-8">
    <div class="panel p-6 relative">
      <h2 class="text-xl font-semibold mb-2">Admin sign in</h2>
      <p class="small-muted mb-4">Sign in with your admin account to manage businesses and users.</p>
      <div class="grid grid-cols-1 gap-3">
        <input id="admin-email" placeholder="Admin email" class="w-full px-3 py-2 rounded-md bg-gray-50" />
        <input id="admin-pass" type="password" placeholder="Password" class="w-full px-3 py-2 rounded-md bg-gray-50" />
        <div class="flex items-center justify-between gap-3">
          <button id="login-btn" class="px-4 py-2 rounded-md bg-indigo-600 text-white btn">Sign in</button>
          <div id="login-msg" class="small-muted"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- dashboard content (hidden if not signed in) -->
  <section id="dashboard" class="hidden space-y-6">

    <!-- Summary cards -->
    <div class="grid md:grid-cols-3 gap-4">
      <div class="panel p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm small-muted">Users</div>
            <div id="count-users" class="text-2xl font-semibold">—</div>
          </div>
          <div class="rounded-md bg-indigo-50 px-3 py-2 text-indigo-700"><i data-feather="users"></i></div>
        </div>
      </div>

      <div class="panel p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm small-muted">Pending Businesses</div>
            <div style="display:flex;align-items:center;gap:6px;">
              <span id="count-mybus" class="text-2xl font-semibold">—</span>
              <span id="pending-badge-summary" class="pending-badge" style="position:static;animation:pulse 1.2s infinite;display:none;">Pending</span>
            </div>
          </div>
          <div class="rounded-md bg-yellow-50 px-3 py-2 text-yellow-600"><i data-feather="briefcase"></i></div>
        </div>
      </div>

      <div class="panel p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm small-muted">Approved</div>
            <div id="count-final" class="text-2xl font-semibold">—</div>
          </div>
          <div class="rounded-md bg-green-50 px-3 py-2 text-green-600"><i data-feather="check-circle"></i></div>
        </div>
      </div>
    </div>

    <!-- Cards container -->
    <div id="cards-area" class="space-y-6">

      <!-- Users view -->
      <div id="view-users" class="tab-content">
        <div class="grid md:grid-cols-3 gap-4" id="users-cards"></div>
      </div>

      <!-- My Business view -->
      <div id="view-mybus" class="tab-content hidden">
        <div class="grid md:grid-cols-3 gap-4" id="mybus-cards"></div>
      </div>

      <!-- Approved view -->
      <div id="view-final" class="tab-content hidden">
        <div class="grid md:grid-cols-3 gap-4" id="final-cards"></div>
      </div>

    </div>
  </section>
</main>

<!-- Modals root -->
<div id="modal-root"></div>

<script type="module">
feather.replace();

/* ---------------------------
   Firebase config (existing)
   --------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDg3wIikjgQMtE29cv9_aoMJCsUQennf34",
  authDomain: "bbo24-88654.firebaseapp.com",
  projectId: "bbo24-88654",
  storageBucket: "bbo24-88654.appspot.com",
  messagingSenderId: "19855713815",
  appId: "1:19855713815:web:ad3c0d52dd66e1680e5e52"
};

import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
import {
  getAuth,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  EmailAuthProvider,
  reauthenticateWithCredential
} from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js';
import {
  getFirestore,
  collection,
  getDocs,
  doc,
  getDoc,
  setDoc,
  deleteDoc,
  serverTimestamp
} from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';
import { getStorage, ref as sref, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js';

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* ---------------------------
   Elements
   --------------------------- */
const loginBtn = document.getElementById('login-btn');
const signoutBtn = document.getElementById('signout-btn');
const adminEmail = document.getElementById('admin-email');
const adminPass = document.getElementById('admin-pass');
const loginMsg = document.getElementById('login-msg');
const loginArea = document.getElementById('login-area');

const dashboard = document.getElementById('dashboard');
const userEmailDisplay = document.getElementById('user-email-display');

const tabUsersBtn = document.getElementById('tab-users-btn');
const tabMyBusBtn = document.getElementById('tab-mybus-btn');
const tabFinalBtn = document.getElementById('tab-final-btn');

const viewUsers = document.getElementById('view-users');
const viewMyBus = document.getElementById('view-mybus');
const viewFinal = document.getElementById('view-final');

const usersCards = document.getElementById('users-cards');
const mybusCards = document.getElementById('mybus-cards');
const finalCards = document.getElementById('final-cards');

const countUsers = document.getElementById('count-users');
const countMybus = document.getElementById('count-mybus');
const countFinal = document.getElementById('count-final');

const modalRoot = document.getElementById('modal-root');
const themeToggle = document.getElementById('theme-toggle');

/* ---------------------------
   Small helpers
   --------------------------- */
function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
async function resolvePdfUrl(pdfVal){ if(!pdfVal) return ''; try{ if(pdfVal.startsWith('http')) return pdfVal; }catch{} try{ return await getDownloadURL(sref(storage,pdfVal)); }catch{return ''; } }

/* ---------------------------
   UI: Tabs
   --------------------------- */
function showTab(tabName) {
  [viewUsers, viewMyBus, viewFinal].forEach(v => v.classList.add('hidden'));
  [tabUsersBtn, tabMyBusBtn, tabFinalBtn].forEach(b => b.classList.remove('bg-indigo-50'));
  if (tabName === 'users') { viewUsers.classList.remove('hidden'); tabUsersBtn.classList.add('bg-indigo-50'); }
  if (tabName === 'mybus') { viewMyBus.classList.remove('hidden'); tabMyBusBtn.classList.add('bg-indigo-50'); }
  if (tabName === 'final') { viewFinal.classList.remove('hidden'); tabFinalBtn.classList.add('bg-indigo-50'); }
}
tabUsersBtn.onclick = () => showTab('users');
tabMyBusBtn.onclick = () => showTab('mybus');
tabFinalBtn.onclick = () => showTab('final');
showTab('users');

/* ---------------------------
   Auth handlers
   --------------------------- */
loginBtn.addEventListener('click', async () => {
  const email = adminEmail.value.trim(), pass = adminPass.value;
  if (!email || !pass) { loginMsg.textContent = 'Enter email & password'; return; }
  try { loginMsg.textContent = 'Signing in...'; await signInWithEmailAndPassword(auth, email, pass); loginMsg.textContent = ''; }
  catch (e) { loginMsg.textContent = e.message || 'Login failed'; console.error(e); }
});
signoutBtn.addEventListener('click', async () => { await signOut(auth); });

/* ---------------------------
   Fetch & render lists (card style)
   --------------------------- */
async function renderUsers() {
  usersCards.innerHTML = '<div class="panel p-4">Loading users...</div>';
  try {
    const q = await getDocs(collection(db, 'users'));
    usersCards.innerHTML = '';
    let count = 0;
    q.forEach(snap => {
      const d = snap.data(); count++;
      usersCards.innerHTML += userCardHtml(snap.id, d);
    });
    if (!count) usersCards.innerHTML = '<div class="panel p-4 small-muted">No users yet</div>';
    countUsers.textContent = String(count);
    feather.replace();
    // wire view buttons
    usersCards.querySelectorAll('.view-user').forEach(b => b.addEventListener('click', async e => {
      const id = e.currentTarget.dataset.id;
      const snap = await getDoc(doc(db, 'users', id));
      if (!snap.exists()) { alert('Not found'); return; }
      openDetailModal(snap.id, snap.data());
    }));
  } catch (err) {
    usersCards.innerHTML = `<div class="panel p-4 text-red-500">Error loading users</div>`;
    console.error(err);
  }
}
function userCardHtml(id, d){
  return `
    <div class="panel p-3">
      <div class="h-40 mb-3 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center">
        ${d.imageUrl ? `<img src="${escapeHtml(d.imageUrl)}" class="card-img" onclick="window.open('${escapeHtml(d.imageUrl)}','_blank')" />` : `<div class="small-muted">No photo</div>`}
      </div>
      <div class="mb-2">
        <div class="font-semibold">${escapeHtml(d.name||'—')}</div>
        <div class="small-muted text-sm">${escapeHtml(d.email||'—')}</div>
      </div>
      <div class="flex items-center justify-between">
        <div class="small-muted text-sm">Owner ID: ${escapeHtml(d.ownerId||id)}</div>
        <div class="flex items-center gap-2">
          <button data-id="${id}" class="view-user btn p-2 rounded bg-indigo-50 text-indigo-700" title="View"><i data-feather="eye"></i></button>
        </div>
      </div>
    </div>
  `;
}

async function renderMyBusiness() {
  mybusCards.innerHTML = '<div class="panel p-4">Loading businesses...</div>';
  try {
    const q = await getDocs(collection(db, 'mybusiness'));
    mybusCards.innerHTML = '';
    let count = 0;
    for (const snap of q.docs) {
      const d = snap.data(); count++;
      const pdf = await resolvePdfUrl(d.pdfUrl || d.pdfPath || '');
      mybusCards.innerHTML += mybusCardHtml(snap.id, d, pdf);
    }
    if (!count) mybusCards.innerHTML = '<div class="panel p-4 small-muted">No pending businesses</div>';
    countMybus.textContent = String(count);
    // Show/hide pending badge in summary
    const pendingBadge = document.getElementById('pending-badge-summary');
    if (pendingBadge) {
      if (count > 0) {
        pendingBadge.style.display = 'inline-block';
      } else {
        pendingBadge.style.display = 'none';
      }
    }
    feather.replace();
    // wire actions
    mybusCards.querySelectorAll('.view-item').forEach(b => b.addEventListener('click', async e => {
      const id = e.currentTarget.dataset.id; const snap = await getDoc(doc(db, 'mybusiness', id));
      if (!snap.exists()) { alert('Not found'); return; }
      openDetailModal(snap.id, snap.data());
    }));
    mybusCards.querySelectorAll('.approve-item').forEach(b => b.addEventListener('click', onApprove));
    mybusCards.querySelectorAll('.reject-item').forEach(b => b.addEventListener('click', onReject));
  } catch (err) {
    mybusCards.innerHTML = `<div class="panel p-4 text-red-500">Error loading businesses</div>`;
    console.error(err);
  }
}
function mybusCardHtml(id, d, pdfLink){
  return `
    <div class="panel p-3">
      <div class="h-40 mb-3 bg-gray-100 rounded-lg overflow-hidden relative flex items-center justify-center">
        <span class="pending-badge">Pending</span>
        ${d.imageUrl ? `<img src="${escapeHtml(d.imageUrl)}" class="card-img" onclick="window.open('${escapeHtml(d.imageUrl)}','_blank')" />` : `<div class="p-4 small-muted">No image</div>`}
      </div>
      <div class="mb-2">
        <div class="font-semibold">${escapeHtml(d.companyname||'—')}</div>
        <div class="small-muted text-sm">${escapeHtml(d.city||'—')} · ${escapeHtml(d.businessType||'—')}</div>
      </div>
      <div class="mb-3 small-muted text-sm">${escapeHtml(d.companyemail||'—')}</div>
      <div class="flex items-center justify-between">
        <div class="text-sm small-muted">${escapeHtml(d.openTime||'')} — ${escapeHtml(d.closeTime||'')}</div>
        <div class="flex items-center gap-2">
          ${pdfLink ? `<button data-pdf="${escapeHtml(pdfLink)}" class="open-pdf btn p-2 rounded bg-indigo-50 text-indigo-700" title="Open PDF"><i data-feather="file-text"></i></button>` : ''}
          <button data-id="${id}" class="view-item btn p-2 rounded bg-indigo-50 text-indigo-700" title="View"><i data-feather="eye"></i></button>
          <button data-id="${id}" class="approve-item btn p-2 rounded bg-green-50 text-green-700" title="Approve"><i data-feather="check"></i></button>
          <button data-id="${id}" class="reject-item btn p-2 rounded bg-red-50 text-red-700" title="Reject"><i data-feather="x"></i></button>
        </div>
      </div>
    </div>
  `;
}

async function renderFinal() {
  finalCards.innerHTML = '<div class="panel p-4">Loading approved items...</div>';
  try {
    const q = await getDocs(collection(db, 'finalorg'));
    finalCards.innerHTML = '';
    let count = 0;
    for (const snap of q.docs) {
      const d = snap.data(); count++;
      finalCards.innerHTML += finalCardHtml(snap.id, d);
    }
    if (!count) finalCards.innerHTML = '<div class="panel p-4 small-muted">No approved organizations</div>';
    countFinal.textContent = String(count);
    feather.replace();
    // wire buttons
    finalCards.querySelectorAll('.view-final').forEach(b => b.addEventListener('click', async e => {
      const id = e.currentTarget.dataset.id; const snap = await getDoc(doc(db, 'finalorg', id));
      if (!snap.exists()) { alert('Not found'); return; }
      openDetailModal(snap.id, snap.data());
    }));
    finalCards.querySelectorAll('.revert-final').forEach(b => b.addEventListener('click', async e => {
      const id = e.currentTarget.dataset.id; const snap = await getDoc(doc(db, 'finalorg', id));
      if (!snap.exists()) { alert('Not found'); return; }
      await setDoc(doc(db, 'mybusiness', id), snap.data());
      await deleteDoc(doc(db, 'finalorg', id));
      alert('Moved back to My Business');
      renderFinal(); renderMyBusiness();
    }));
    finalCards.querySelectorAll('.delete-final').forEach(b => b.addEventListener('click', async e => {
      const id = e.currentTarget.dataset.id;
      showPasswordConfirmModal(async (pw) => {
        try {
          const user = auth.currentUser;
          if (!user) throw new Error('Not signed in');
          const cred = EmailAuthProvider.credential(user.email, pw);
          await reauthenticateWithCredential(user, cred);
          await deleteDoc(doc(db, 'finalorg', id));
          alert('Deleted.');
          renderFinal();
        } catch (err) {
          alert('Re-auth failed: ' + (err.message || err));
          console.error(err);
        }
      });
    }));
  } catch (err) {
    finalCards.innerHTML = `<div class="panel p-4 text-red-500">Error loading approved orgs</div>`;
    console.error(err);
  }
}
function finalCardHtml(id, d){
  const imgHtml = d.imageUrl ? `<img src="${escapeHtml(d.imageUrl)}" class="card-img" onclick="window.open('${escapeHtml(d.imageUrl)}','_blank')" />` : `<div class="p-4 small-muted">No image</div>`;
  return `
    <div class="panel p-3">
      <div class="h-40 mb-3 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center">${imgHtml}</div>
      <div class="mb-2">
        <div class="font-semibold">${escapeHtml(d.companyname||'—')}</div>
        <div class="small-muted text-sm">${escapeHtml(d.city||'—')} · ${escapeHtml(d.businessType||'—')}</div>
      </div>
      <div class="mb-3 small-muted text-sm">${escapeHtml(d.companyphone||'—')}</div>
      <div class="flex items-center justify-between">
        <div class="small-muted text-sm">Owner: ${escapeHtml(d.ownername||'—')}</div>
        <div class="flex items-center gap-2">
          <button data-id="${id}" class="view-final btn p-2 rounded bg-indigo-50 text-indigo-700" title="View"><i data-feather="eye"></i></button>
          <button data-id="${id}" class="revert-final btn p-2 rounded bg-yellow-50 text-yellow-700" title="Revert"><i data-feather="rotate-ccw"></i></button>
          <button data-id="${id}" class="delete-final btn p-2 rounded bg-red-50 text-red-700" title="Delete"><i data-feather="trash-2"></i></button>
        </div>
      </div>
    </div>
  `;
}

/* ---------------------------
   Modal: Detail view (images, emails, pdfs clickable)
   --------------------------- */
function openDetailModal(id, data) {
  const entries = Object.entries(data).map(([k, v]) => {
    if (v === undefined || v === null || v === '') return '';
    const s = v.toString();
    const val = escapeHtml(s);
    if (s.includes('@') && !s.startsWith('http')) {
      return `<div class="detail-row"><strong>${escapeHtml(k)}:</strong> <a href="mailto:${val}" class="text-indigo-600 underline">${val}</a></div>`;
    }
    if (k.toLowerCase().includes('image') || k.toLowerCase().includes('logo') || s.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
      return `<div class="detail-row"><strong>${escapeHtml(k)}:</strong><div class="mt-2"><img src="${val}" class="card-img" onclick="window.open('${val}','_blank')" alt="${escapeHtml(k)}"></div></div>`;
    }
    if (s.toLowerCase().includes('.pdf') || s.includes('pdf')) {
      return `<div class="detail-row"><strong>${escapeHtml(k)}:</strong> <a href="${val}" target="_blank" class="text-indigo-600 underline">Open PDF</a></div>`;
    }
    return `<div class="detail-row"><strong>${escapeHtml(k)}:</strong> ${val}</div>`;
  }).join('');
  modalRoot.innerHTML = `
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 fade-in">
      <div class="w-full max-w-3xl panel p-6 rounded-lg" style="max-height:85vh; overflow:auto">
        <button id="close-detail" class="absolute top-5 right-6 p-2 rounded-full panel"><i data-feather="x"></i></button>
        <h3 class="text-lg font-semibold mb-3">${escapeHtml(data.companyname||data.name||'Details')}</h3>
        <div class="space-y-2">${entries}</div>
      </div>
    </div>
  `;
  feather.replace();
  document.getElementById('close-detail').onclick = () => modalRoot.innerHTML = '';
}

/* ---------------------------
   Password confirm modal for delete (reauth)
   --------------------------- */
function showPasswordConfirmModal(onConfirm) {
  modalRoot.innerHTML = `
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 fade-in">
      <div class="w-full max-w-md panel p-6 rounded-lg">
        <h3 class="text-lg font-semibold mb-2">Confirm Delete</h3>
        <p class="small-muted mb-4">Enter your current admin password to confirm deletion.</p>
        <input id="confirm-pass" type="password" placeholder="Password" class="w-full px-3 py-2 rounded-md mb-3 bg-gray-50" />
        <div class="flex justify-end gap-2">
          <button id="cancel-pass" class="px-3 py-2 rounded-md btn">Cancel</button>
          <button id="ok-pass" class="px-3 py-2 rounded-md bg-red-500 text-white btn">Confirm & Delete</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('cancel-pass').onclick = () => modalRoot.innerHTML = '';
  document.getElementById('ok-pass').onclick = () => {
    const pw = document.getElementById('confirm-pass').value;
    modalRoot.innerHTML = '';
    onConfirm(pw);
  };
}

/* ---------------------------
   Approve & Reject flows (same behavior)
   --------------------------- */
async function onApprove(e) {
  const id = e.currentTarget.dataset.id;
  const snap = await getDoc(doc(db, 'mybusiness', id));
  if (!snap.exists()) { alert('Not found'); return; }
  await setDoc(doc(db, 'finalorg', id), snap.data());
  await deleteDoc(doc(db, 'mybusiness', id));
  renderMyBusiness(); renderFinal();
}
async function onReject(e) {
  const id = e.currentTarget.dataset.id;
  if (!confirm('Reject this business?')) return;
  await deleteDoc(doc(db, 'mybusiness', id));
  renderMyBusiness();
}

/* ---------------------------
   Auth state watcher
   --------------------------- */
onAuthStateChanged(auth, user => {
  if (user) {
    // show dashboard
    loginArea.classList.add('hidden');
    dashboard.classList.remove('hidden');
    userEmailDisplay.textContent = user.email;
    renderUsers(); renderMyBusiness(); renderFinal();
  } else {
    loginArea.classList.remove('hidden');
    dashboard.classList.add('hidden');
    userEmailDisplay.textContent = '';
    usersCards.innerHTML = mybusCards.innerHTML = finalCards.innerHTML = '';
    countUsers.textContent = countMybus.textContent = countFinal.textContent = '—';
  }
});

/* ---------------------------
   Theme toggle (persist)
   --------------------------- */
(function initTheme() {
  const saved = localStorage.getItem('admin-dark');
  if (saved === '1') document.documentElement.classList.add('dark');
  themeToggle.addEventListener('click', () => {
    const isDark = document.documentElement.classList.toggle('dark');
    localStorage.setItem('admin-dark', isDark ? '1' : '0');
    feather.replace();
  });
})();

/* ---------------------------
   Minor wiring: open pdf buttons
   --------------------------- */
document.addEventListener('click', (ev) => {
  const el = ev.target.closest && ev.target.closest('.open-pdf');
  if (el) {
    const link = el.dataset.pdf;
    if (link) window.open(link, '_blank');
  }
});

/* ---------------------------
   Initial feather icons
   --------------------------- */
feather.replace();
</script>
</body>
</html>
